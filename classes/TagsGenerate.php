<?php
class TagsGenerate{private $text;private $title;private $teaser;const MIN_CHAR=3;const STOP_WORDS='a ha,a lô,à &#417;i,á,à,á à,&#7841;,&#7841; &#417;i,ai,ai ai,ai n&#7845;y,ái,ái chà,ái dà,alô,amen,áng,ào,&#7855;t,&#7855;t h&#7859;n,&#7855;t là,âu là,&#7847;u &#417;,&#7845;y,bài,b&#7843;n,bao gi&#7901;,bao lâu,bao n&#7843;,bao nhiêu,bay bi&#7871;n,b&#7857;ng,b&#7857;ng &#7845;y,b&#7857;ng không,b&#7857;ng n&#7845;y,b&#7855;t &#273;&#7847;u t&#7915;,b&#7853;p bà b&#7853;p bõm,b&#7853;p bõm,b&#7845;t ch&#7907;t,b&#7845;t c&#7913;,b&#7845;t &#273;&#7891;,b&#7845;t giác,b&#7845;t k&#7875;,b&#7845;t kì,b&#7845;t k&#7923;,b&#7845;t lu&#7853;n,b&#7845;t nh&#432;&#7907;c,b&#7845;t quá,b&#7845;t thình lình,b&#7845;t t&#7917;,bây b&#7849;y,bây ch&#7915;,bây gi&#7901;,bây gi&#7901;,bây nhiêu,b&#7845;y,b&#7845;y gi&#7901;,b&#7845;y ch&#7847;y,b&#7845;y ch&#7915;,b&#7845;y gi&#7901;,b&#7845;y lâu,b&#7845;y lâu nay,b&#7845;y nay,b&#7845;y nhiêu,bèn,béng,b&#7875;n,b&#7879;t,bi&#7871;t bao,bi&#7871;t bao nhiêu,bi&#7871;t ch&#7915;ng nào,bi&#7871;t &#273;âu,bi&#7871;t &#273;âu ch&#7915;ng,bi&#7871;t &#273;âu &#273;&#7845;y,bi&#7871;t m&#7845;y,b&#7897;,b&#7897;i ph&#7847;n,bông,b&#7895;ng,b&#7895;ng ch&#7889;c,b&#7895;ng d&#432;ng,b&#7895;ng &#273;âu,b&#7895;ng không,b&#7895;ng nhiên,b&#7887; m&#7865;,b&#7899;,b&#7903;i,b&#7903;i ch&#432;ng,b&#7903;i nh&#432;ng,b&#7903;i th&#7871;,b&#7903;i v&#7853;y,b&#7903;i vì,b&#7913;c,c&#7843;,c&#7843; th&#7843;y cái,các,c&#7843; th&#7843;y,c&#7843; th&#7875;,càng,c&#259;n,c&#259;n c&#7855;t,c&#7853;t l&#7921;c,c&#7853;t s&#7913;c,cây,cha ,cha ch&#7843;,chành ch&#7841;nh,chao ôi,ch&#7855;c,ch&#7855;c h&#7859;n,ch&#259;n ch&#7855;n,ch&#259;ng,ch&#7859;ng l&#7869;,ch&#7859;ng nh&#7919;ng,ch&#7859;ng n&#7919;a,ch&#7859;ng ph&#7843;i,ch&#7853;c,ch&#7847;m ch&#7853;p,ch&#7871;t n&#7895;i,ch&#7871;t ti&#7879;t,ch&#7871;t th&#7853;t,chí ch&#7871;t,ch&#7881;n,chính,chính là,chính th&#7883;,ch&#7881;,ch&#7881; do,ch&#7881; là,ch&#7881; t&#7841;i,ch&#7881; vì,chi&#7871;c,cho &#273;&#7871;n,cho &#273;&#7871;n khi,cho nên,cho t&#7899;i,cho t&#7899;i khi,choa,ch&#7889;c ch&#7889;c,ch&#7899;,ch&#7899; chi,ch&#7907;t,chú,chu cha,chú mày,chú mình,chui cha,chùn chùn,chùn ch&#361;n,ch&#7911;n,chung c&#7909;c,chung qui,chung quy,chung quy l&#7841;i,chúng mình,chúng ta,chúng tôi,ch&#7913;,ch&#7913; l&#7883;,có ch&#259;ng là,có d&#7877;,có v&#7867;,cóc khô,coi b&#7897;,coi mòi,con,còn,cô,cô mình,c&#7893; lai,công nhiên,c&#417;,c&#417; ch&#7915;ng,c&#417; h&#7891;,c&#417; mà,c&#417;n,cu c&#7853;u,c&#7911;a,cùng,cùng c&#7921;c,cùng nhau,cùng v&#7899;i,c&#361;ng,c&#361;ng nh&#432;,c&#361;ng v&#7853;y,c&#361;ng v&#7853;y thôi,c&#7913;,c&#7913; vi&#7879;c,c&#7921;c kì c&#7921;c k&#7923;,c&#7921;c l&#7921;c,cu&#7897;c,cu&#7889;n,dào,d&#7841;,d&#7847;n dà,d&#7847;n d&#7847;n,d&#7847;u sao,d&#7851;u,d&#7851;u sao,d&#7877; s&#7907;,d&#7877; th&#432;&#7901;ng,do,do vì,do &#273;ó,do v&#7853;y,d&#7903; ch&#7915;ng,dù cho,dù r&#7857;ng,duy,d&#7919;,d&#432;&#7899;i,&#273;ã,&#273;&#432;&#7907;c,&#273;&#7841;i &#273;&#7875;,&#273;&#7841;i lo&#7841;i,&#273;&#7841;i nhân,&#273;&#7841;i phàm,&#273;ang,&#273;áng l&#7869;,&#273;áng lí,&#273;áng lý,&#273;ành &#273;&#7841;ch,&#273;ánh &#273;ùng,&#273;áo &#273;&#7875;,n&#7845;y,nên chi,n&#7873;n,n&#7871;u,n&#7871;u nh&#432;,ngay,ngay c&#7843;,ngay l&#7853;p t&#7913;c,ngay lúc,ngay khi,ngay t&#7915;,ngay t&#7913;c kh&#7855;c,ngày càng,ngày ngày,ngày x&#432;a,ngày x&#7917;a,ng&#259;n ng&#7855;t,nghe ch&#7915;ng,nghe &#273;âu,nghen,nghi&#7877;m nhiên,ngh&#7881;m,ngõ h&#7847;u,ngo&#7843;i,ngoài,ngôi,ng&#7885;n,ng&#7885;t,ng&#7897; nh&#7905;,ng&#432;&#417;i,nhau,nhân d&#7883;p,nhân ti&#7879;n,nh&#7845;t,nh&#7845;t &#273;án,nh&#7845;t &#273;&#7883;nh,nh&#7845;t lo&#7841;t,nh&#7845;t lu&#7853;t,nh&#7845;t m&#7921;c,nh&#7845;t nh&#7845;t,nh&#7845;t quy&#7871;t,nh&#7845;t sinh,nh&#7845;t tâm,nh&#7845;t t&#7873;,nh&#7845;t thi&#7871;t,nhé,nh&#7881;,nhiên h&#7853;u,nhi&#7879;t li&#7879;t,nhón nhén,nh&#7905; ra,nhung nh&#259;ng,nh&#432;,nh&#432; ch&#417;i,nh&#432; không,nh&#432; qu&#7843;,nh&#432; th&#7875;,nh&#432; tu&#7891;ng,nh&#432; v&#7853;y,nh&#432;ng nh&#432;ng mà,nh&#7919;ng,nh&#7919;ng ai,nh&#7919;ng nh&#432;,nh&#432;&#7907;c b&#7857;ng,nó,nóc,n&#7885;,n&#7893;i,n&#7899;,n&#7919;a,n&#7913;c n&#7903;,oai oái,oái,ô hay,ô hô,ô kê,ô kìa,&#7891;,ôi chao,ôi thôi,&#7889;i dào,&#7889;i gi&#7901;i,&#7889;i gi&#7901;i &#417;i,ôkê,&#7893;ng,&#417;,&#417; hay,&#417; kìa,&#7901;,&#7899;,&#417;i,ph&#7843;i,ph&#7843;i chi,ph&#7843;i ch&#259;ng,ph&#259;n ph&#7855;t,ph&#7855;t,phè,ph&#7881; phui,pho,phóc,ph&#7887;ng,ph&#7887;ng nh&#432;,phót,ph&#7889;c,ph&#7909;t,ph&#432;&#417;ng chi,ph&#7913;t,qua quít,qua quýt,qu&#7843;,qu&#7843; &#273;úng,qu&#7843; làqu&#7843; tang,qu&#7843; th&#7853;t,qu&#7843; tình,qu&#7843; v&#7853;y,quá,quá ch&#7915;ng,quá &#273;&#7897;,quá &#273;&#7895;i,quá l&#7855;m,quá sá,quá th&#7875;,quá tr&#7901;i,quá &#432;,quá xá,quý h&#7891;,quy&#7875;n,quy&#7871;t,quy&#7871;t nhiên,ra,ra ph&#7871;t,ra trò,ráo,ráo tr&#7885;i,rày,r&#259;ng,r&#7857;ng,r&#7857;ng là,r&#7845;t,r&#7845;t chi là,r&#7845;t &#273;&#7895;i,r&#7845;t m&#7921;c,ren rén,rén,rích,ri&#7879;t,riu ríu,rón rén,r&#7891;i,r&#7889;t c&#7909;c,r&#7889;t cu&#7897;c,rút c&#7909;c,r&#7913;a,sa s&#7843; s&#7841;ch,sao,sau chót,sau cùng,sau cu&#7889;i,sau &#273;ó,s&#7855;p,s&#7845;t,s&#7869;,sì,song le,s&#7889; là,s&#7889;t s&#7897;t,s&#7903; d&#297;,suýt,s&#7921;,tà tà,t&#7841;i,t&#7841;i vì,t&#7845;m,t&#7845;n,t&#7921; vì,tanh,t&#259;m t&#7855;p,t&#7855;p,t&#7855;p l&#7921;,t&#7845;t c&#7843;,t&#7845;t t&#7847;n t&#7853;t,t&#7845;t t&#7853;t,t&#7845;t th&#7843;y,tênh,tha h&#7891;,thà,thà là,thà r&#7857;ng,thái quá,than ôi,thanh,thành ra,thành th&#7917;,th&#7843;o hèn,th&#7843;o nào,th&#7853;m,th&#7853;m chí,th&#7853;t l&#7921;c,th&#7853;t v&#7853;y,th&#7853;t ra,th&#7849;y,th&#7871;,th&#7871; à,th&#7871; là,th&#7871; mà,th&#7871; nào,th&#7871; nên,th&#7871; ra,th&#7871; thì,th&#7871;ch,thi tho&#7843;ng,thì,thình lình,th&#7881;nh tho&#7843;ng,tho&#7841;t,tho&#7841;t nhiên,tho&#7855;t,th&#7887;m,th&#7885;t,th&#7889;c,th&#7889;c tháo,th&#7897;c,thôi,th&#7889;t,th&#7889;t nhiên,thu&#7847;n,th&#7909;c m&#7841;ng,thúng th&#7855;ng,th&#7917;a,th&#7921;c ra,th&#7921;c v&#7853;y,th&#432;&#417;ng ôi,ti&#7879;n th&#7875;,ti&#7871;p &#273;ó,ti&#7871;p theo,tít mù,t&#7887; ra,t&#7887; v&#7867;,tò te,toà,toé khói,to&#7865;t,t&#7885;t,t&#7889;c t&#7843;,tôi,t&#7889;i &#432;,tông t&#7889;c,t&#7897;t tràn cung mây,trên,tr&#7875;n,tr&#7879;t,tr&#7871;u tráo,tr&#7879;u tr&#7841;o,trong,tr&#7887;ng,tr&#7901;i &#273;&#7845;t &#417;i,tr&#432;&#7899;c,tr&#432;&#7899;c &#273;ây,tr&#432;&#7899;c &#273;ó,tr&#432;&#7899;c kia,tr&#432;&#7899;c nay,tr&#432;&#7899;c tiên,tr&#7915; phi,tù tì,tu&#7847;n t&#7921;,tu&#7889;t lu&#7889;t,tu&#7889;t tu&#7891;n tu&#7897;t,tu&#7889;t tu&#7897;t,tuy,tuy nhiên,tuy r&#7857;ng,tuy th&#7871;,tuy v&#7853;y,tuy&#7879;t nhiên,t&#7915;ng,t&#7913;c thì,t&#7913;c t&#7889;c,t&#7921;u trung,&#7911;a,úi,úi chà,úi dào,&#432;,&#7913; h&#7921;,&#7913; &#7915;,&#7917;,&#7915;,và,v&#7843; ch&#259;ng,v&#7843; l&#7841;i,v&#7841;n nh&#7845;t,v&#259;ng tê,v&#7851;n,vâng,v&#7853;y,v&#7853;y là,v&#7853;y thì,veo,veo veo,vèo,v&#7873;,vì,vì ch&#432;ng,vì th&#7871;,vì v&#7853;y,ví b&#7857;ng,ví dù,ví ph&#7887;ng,ví th&#7917;,v&#7883; t&#7845;t,vô hình trung,vô k&#7875;,vô lu&#7853;n,vô vàn,v&#7889;n d&#297;,v&#7899;i,v&#7899;i l&#7841;i,v&#7903;,vung tàn tán,vung tán tàn,vung thiên &#273;&#7883;a,v&#7909;t,v&#7915;a m&#7899;i,xa x&#7843;,x&#259;m x&#259;m,x&#259;m x&#7855;m,x&#259;m xúi,x&#7873;nh x&#7879;ch,x&#7879;p,xi&#7871;t bao,xoành xo&#7841;ch,xo&#7859;n,xoét,xo&#7865;t,xon xón,xu&#7845;t kì b&#7845;t ý,xu&#7845;t k&#7923; b&#7845;t ý,xu&#7875;,xu&#7889;ng,ý,ý ch&#7915;ng,ý da';const BAD_WORDS='nguy&#7877;n bá thanh, d&#432;&#417;ng chí d&#361;ng, tr&#432;&#417;ng t&#7845;n sang, nguy&#7877;n minh tri&#7871;t, ch&#7911; t&#7883;ch n&#432;&#7899;c, th&#7911; t&#432;&#7899;ng, chính ph&#7911;, th&#7911; t&#432;&#7899;ng x, t&#7893;ng bí th&#432;, nguy&#7877;n phú tr&#7885;ng, tr&#7885;ng lú,  nguy&#7877;n t&#7845;n d&#361;ng, hoàng sa, tr&#432;&#7901;ng sa, hoang sa, truong sa, nguy&#7877;n t&#7845;n d&#361;ng, nguyen tan dung, &#273;&#7843;ng,công an,&#273;&#7843;ng c&#7897;ng s&#7843;n,dang cong san,vi&#7879;t nam c&#7897;ng hòa,vietnam cong hoa, vietnam c&#7897;ng hòa,viet nam cong hoa, vn cong hoa,vi&#7879;t nam dân ch&#7911; c&#7897;ng hòa,viet nam dan chu cong hoa,vietnam dan chu cong hoa,ph&#7843;n &#273;&#7897;ng,b&#7841;o &#273;&#7897;ng,b&#7841;o lo&#7841;n,bác h&#7891;,h&#7891; chí minh,nguy&#7877;n ái qu&#7889;c,&#273;&#7883;t,l&#7891;n,bu&#7891;i,dái,c&#7863;c';const GOOGLE_SUGGEST_LINK='http://google.com.vn/complete/search?output=toolbar&q=%s';const COCCOC_SUGGEST_KEYWORDS_LINK='http://coccoc.com/autocomplete.json?term=%s';function __construct($text,$title='',$teaser=''){$this->text=self::clean($text);$this->title=mb_strtolower(self::clean($title),'UTF-8');$this->teaser=mb_strtolower(self::clean($teaser),'UTF-8');}private static function clean($text){$text=trim(strip_tags($text));$text=preg_replace('/[^\p{L}\p{N}\s]/u',' ',$text);$array_special_char=array(chr(9),chr(10),chr(13),"nbsp","-",'"',".","?",":","*","%","#","|","/","\\",",","‘","’",'“','”',"&nbsp;");$text=str_replace($array_special_char," ",$text);$text=str_replace("   "," ",$text);$text=str_replace("  "," ",$text);$text=str_replace("  "," ",$text);$text=str_replace("  "," ",$text);$text=str_replace("  "," ",$text);$text=str_replace("  "," ",$text);$text=str_replace("  "," ",$text);return trim($text);}private function extract_keywords(){$text=$this->text;$title=$this->title;$teaser=$this->teaser;$collection_words=array();$content_arr=explode(" ",$text);$content_arr=array_filter($content_arr);$content_arr=array_values($content_arr);$upper_words=array();foreach($content_arr as $key=>$value):if((ord($value{0})>=65&&ord($value{0})<=90)){$temp=$value;$check=false;for($i=1;$i<=5;$i++){if(isset($content_arr[$key+$i])&&(ord($content_arr[$key+$i]{0})>=65&&ord($content_arr[$key+$i]{0})<=90)){$check=true;$temp.=' '.$content_arr[$key+$i];}else{break;}}if($check){$temp=mb_strtolower($temp,'UTF-8');$collection_words[]=$temp;$upper_words[]=$temp;}}endforeach;$upper_words=array_count_values($upper_words);$text=mb_strtolower($text,'UTF-8');$stop_words=explode(',',self::STOP_WORDS);foreach($stop_words as $stop_word){$text=str_replace(' '.$stop_word.' ',' ',$text);}$content_arr=explode(" ",mb_strtolower($text,'UTF-8'));$content_arr=array_filter($content_arr);$content_arr=array_values($content_arr);foreach($content_arr AS $key=>$one_word){if(mb_strlen($one_word,'UTF-8')<self::MIN_CHAR){unset($content_arr[$key]);}}$content_arr=array_values($content_arr);foreach($content_arr as $k=>$value):if(isset($content_arr[$k])):$collection_words[]=trim($value);$temp=$value;for($i=1;$i<=5;$i++){for($j=1;$j<=$i;$j++){if($k+$j<count($content_arr)-$j){$temp1=isset($content_arr[$k+$j])?$content_arr[$k+$j]:'';$temp.=' '.$temp1;}}$collection_words[]=trim($temp);$temp='';}endif;endforeach;$collection_words=array_filter($collection_words);$collection_words_count=array_count_values($collection_words);$keywords_match=array();foreach($collection_words_count as $one_word=>$point){if(array_key_exists($one_word,$upper_words)){$point*=$upper_words[$one_word];}$arr_exp=explode(" ",$one_word);$point=(count($arr_exp)>1)?$point*count($arr_exp)*1.5:$point;if(mb_strpos($title,$one_word)){$point*=$point;}if(mb_strpos($teaser,$one_word)){$point+=5;}$keywords_match[$one_word]=$point;}arsort($keywords_match);return $keywords_match;}private function coccoc_trends($keywords){$tags=array();if(!$keywords||empty($keywords)){return false;}$total_point=array_sum($keywords);foreach(array_keys($keywords)as $keyword){$link=sprintf(self::COCCOC_SUGGEST_KEYWORDS_LINK,$keyword);$ch=curl_init();curl_setopt($ch,CURLOPT_URL,$link);curl_setopt($ch,CURLOPT_RETURNTRANSFER,1);$server_output=curl_exec($ch);curl_close($ch);$cc_result=json_decode($server_output,true);if(isset($cc_result['suggestions'])&&!empty($cc_result['suggestions'])){$keyword_point=ceil(($keywords[$keyword]/$total_point)*100);$cc_result['suggestions']=array_slice($cc_result['suggestions'],0,$keyword_point);$tags=array_merge($tags,$cc_result['suggestions']);}}return $tags;}private function google_trends($keywords){$tags=array();if(!$keywords||empty($keywords)){return false;}$hot_keywords=@reset(array_keys($keywords));$total_point=array_sum($keywords);foreach(array_keys($keywords)as $keyword){$suggest_result=array();$link=sprintf(self::GOOGLE_SUGGEST_LINK,urlencode($keyword));$ch=curl_init();curl_setopt($ch,CURLOPT_URL,$link);curl_setopt($ch,CURLOPT_RETURNTRANSFER,1);$server_output=curl_exec($ch);$server_output=utf8_encode($server_output);curl_close($ch);$google_xml=new SimpleXMLElement($server_output);foreach($google_xml->CompleteSuggestion as $complate_suggest){$suggest_result[]=(string)$complate_suggest->suggestion->attributes()->data;}if(isset($suggest_result)&&!empty($suggest_result)){$suggest_result=$this->sort_keywords($suggest_result);$keyword_point=ceil(($keywords[$keyword]/$total_point)*100);$suggest_result=array_slice($suggest_result,0,$keyword_point);$tags=array_merge($tags,$suggest_result);}else{$keywords_suggest=self::coccoc_trends(array($keyword=>$keywords[$keyword]));$keywords_suggest=$this->sort_keywords($keywords_suggest);$keyword_point=ceil(($keywords[$keyword]/$total_point)*100);$keywords_suggest=array_slice($keywords_suggest,0,$keyword_point);$tags=array_merge($tags,$keywords_suggest);}}return array_unique($tags);}private function sort_keywords($keywords){$keywords=array_count_values($keywords);$this->title=mb_strtolower($this->title,'UTF-8');$this->teaser=mb_strtolower($this->teaser,'UTF-8');$this->text=mb_strtolower($this->text,'UTF-8');$bad_words=explode(',',self::BAD_WORDS);$bad_words=array_map('trim',$bad_words);foreach($keywords as $keyword=>$value){$bad=false;$keyword_lower=mb_strtolower($keyword);foreach($bad_words as $bad_word){if(mb_strpos(' '.$keyword_lower.' ',$bad_word)){$bad=true;unset($keywords[$keyword]);break;}}if($bad){continue;}$keyword_check=mb_strtolower($keyword,'UTF-8');$keyword_check=self::clean($keyword_check);if(trim($keyword_check)==''){unset($keywords[$keyword]);continue;}if(mb_strpos($this->title,$keyword_check)){$keywords[$keyword]+=100;}if(mb_strpos($this->teaser,$keyword_check)){$keywords[$keyword]+=20;}if(mb_strpos($this->text,$keyword_check)){$keywords[$keyword]+=10;}$keywords_compare=explode(' ',$keyword_check);$keywords_compare=array_filter($keywords_compare);foreach($keywords_compare as $one_word){if(mb_strpos($this->title,$one_word)){$keywords[$keyword]+=10;}if(mb_strpos($this->teaser,$one_word)){$keywords[$keyword]+=5;}if(mb_strpos($this->text,$one_word)){$keywords[$keyword]++;}}}arsort($keywords);return array_keys($keywords);}public function generate($limit=10,$min_word=1){$keywords=$this->extract_keywords();$bad_words=explode(',',self::BAD_WORDS);$bad_words=array_map('trim',$bad_words);$keywords=array_slice($keywords,0,$limit);$keywords=$this->google_trends($keywords);foreach($keywords as $key=>$keyword){foreach($bad_words as $bad_word){$keyword_lower=removeAccent($keyword);$keyword_lower=strtolower($keyword_lower);$bad_word=removeAccent($bad_word);if(strpos(' '.$keyword_lower.' ',$bad_word)){unset($keywords[$key]);break;}}if($min_word>=2){$count_word=explode(' ',$keyword);if(count($count_word)<$min_word){unset($keywords[$key]);}}}if($keywords&&!empty($keywords)){$keywords=array_unique($keywords);$keywords=$this->sort_keywords($keywords);$keywords=array_filter($keywords);return array_slice($keywords,0,$limit);}return array();}}function TagsGenerate($contents,$title='',$teaser=''){return new TagsGenerate($contents,$title,$teaser);}?>